@page "/student"
@using Microsoft.EntityFrameworkCore
@using AttendanceSystem.Data.Models
@inject AttendanceDbContext DbContext

<PageTitle>My Classes (Student)</PageTitle>

<div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-semibold text-gray-800 mb-6 text-center">My Classes</h1>

    @if (StudentClasses.Count == 0)
    {
        <p class="text-center text-gray-500">You're not enrolled in any classes yet.</p>
    }
    else
    {
        <div class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
            @foreach (var classItem in StudentClasses)
{
   <a href="student/class/@classItem.Id" 
   class="block no-underline text-inherit focus:outline-none focus:ring-2 focus:ring-blue-300">
    <div class="text-gray-800 border border-gray-300 rounded-xl bg-white p-5 hover:shadow-md transition-shadow duration-200">
        <h2 class="text-lg font-semibold mb-2">@classItem.Name</h2>
        <div class="text-sm space-y-1">
            <p><strong>Instructor:</strong> @classItem.Instructor</p>
            <p><strong>Time:</strong> @classItem.Time</p>
            <p><strong>Room:</strong> @classItem.Room</p>
        </div>
        <div class="mt-4 flex justify-between items-center text-sm">
            <span>Attendance: <strong>@CalculateAttendancePercentage(classItem)%</strong></span>
            <span class="font-medium text-@(GetAttendanceColor(classItem))">
                @(CalculateAttendancePercentage(classItem) >= 75 ? "Good" : "Low")
            </span>
        </div>
    </div>
</a>


}

        </div>
    }
</div>

@code {
    private List<ClassItem> StudentClasses = new();

    protected override async Task OnInitializedAsync()
    {
        var studentId = 2; // Replace with actual logged-in student ID

        var enrolledClasses = await DbContext.StudentCourses
            .Where(sc => sc.StudentID == studentId)
            .Join(DbContext.Classes,
                sc => sc.ClassID,
                c => c.ClassID,
                (sc, c) => c)
            .Include(c => c.Instructor)
            .Include(c => c.AttendanceRecords)
            .ToListAsync();

        var studentAttendance = await DbContext.AttendanceRecords
            .Where(ar => ar.StudentID == studentId)
            .ToListAsync();

        StudentClasses = enrolledClasses.Select(c => new ClassItem(
            c.ClassID,
            c.Name,
            c.Instructor?.Name ?? "Unknown",
            c.Time,
            c.Room,
            c.TotalStudents,
            studentAttendance
                .Where(ar => ar.ClassID == c.ClassID)
                .Select(ar => new AttendanceRecord { Date = ar.Date, Status = ar.Status })
                .ToList()
        )).ToList();
    }

    private double CalculateAttendancePercentage(ClassItem classItem)
    {
        if (classItem.AttendanceRecords.Count == 0) return 0;
        var presentCount = classItem.AttendanceRecords.Count(r => r.Status == "Present");
        return Math.Round((double)presentCount / classItem.AttendanceRecords.Count * 100, 2);
    }

    private string GetAttendanceColor(ClassItem classItem)
    {
        var percentage = CalculateAttendancePercentage(classItem);
        return percentage >= 75 ? "green-600" : "red-600";
    }

    public class ClassItem
    {
        public int? Id { get; set; }
        public string? Name { get; set; }
        public string? Instructor { get; set; }
        public string? Time { get; set; }
        public string? Room { get; set; }
        public int? Students { get; set; }
        public List<AttendanceRecord> AttendanceRecords { get; set; }

        public ClassItem(int id, string name, string instructor, string time, string room, int students, List<AttendanceRecord> attendanceRecords)
        {
            Id = id;
            Name = name;
            Instructor = instructor;
            Time = time;
            Room = room;
            Students = students;
            AttendanceRecords = attendanceRecords;
        }
    }
}
